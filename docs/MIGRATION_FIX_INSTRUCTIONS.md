# Migration Fix Instructions

## Problem
The migration system had multiple conflicting "initial" migrations and many empty migrations, causing all migrations to show as "Pending". This prevented the `failed_messages` table from being properly recognized/created.

## Solution Applied
Created a consolidated migration (`20260205000000_ConsolidatedSchema`) that includes all necessary table definitions in one clean migration.

## Steps to Apply the Fix

### Option 1: Fresh Database (Development Environments)
If you can afford to lose existing data:

```bash
# Navigate to the Infrastructure project
cd src/MailEngine.Infrastructure

# Apply the consolidated migration
dotnet ef database update 20260205000000_ConsolidatedSchema --startup-project ../MailEngine.Functions --context MailEngineDbContext
```

### Option 2: Existing Database (Production/Staging Environments)
If you need to preserve existing data:

1. **First, backup your database!**

2. **Check what tables currently exist in your database:**
   - Connect to your database and run queries to see which tables from the expected schema already exist

3. **Option A: Manual Migration History Update**
   - If the tables from `20260202162456_InitialCreateWithNamingConventions` already exist in your database, you can manually insert a record into the `__EFMigrationsHistory` table:
   
   ```sql
   INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion") 
   VALUES ('20260202162456_InitialCreateWithNamingConventions', '8.0.0');
   ```
   
   Then apply remaining migrations:
   ```bash
   dotnet ef database update --startup-project ../MailEngine.Functions --context MailEngineDbContext
   ```

4. **Option B: Start Fresh with Current Schema**
   - Generate a migration that matches your current database state:
   
   ```bash
   # Remove all migration files except the consolidated one
   # Then scaffold a new migration that matches the current state
   dotnet ef migrations add AfterCleanup --startup-project ../MailEngine.Functions --context MailEngineDbContext --force
   ```
   
   After this, you can remove the old migration files and keep only the consolidated one and any new "AfterCleanup" migration.

## Recommended Cleanup
After successfully applying the fix, consider removing the old problematic migration files (but keep backups):

- `20260204213713_InitialCreate.cs` and `.Designer.cs` (duplicate initial migration)
- All the empty migration files with confusing names like "shyte_fest", "Hayi", etc.

Keep only:
- `20260202162456_InitialCreateWithNamingConventions` (original working migration)
- `20260202190330_AddAutoGeneratedGuidsForPrimaryKeys` (contains important changes)
- `20260204225348_Tables_Again` (adds processed_messages table)

## Emergency Fix for Migration History
If you're still experiencing issues where all migrations show as "Pending", you may need to manually update the migration history table directly in the database:

1. Connect to your PostgreSQL database directly
2. Execute this SQL to mark the proper migrations as applied:
```sql
INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES
('20260202162456_InitialCreateWithNamingConventions', '8.0.0'),
('20260202190330_AddAutoGeneratedGuidsForPrimaryKeys', '8.0.0'),
('20260204225348_Tables_Again', '8.0.0')
ON CONFLICT DO NOTHING;
```

3. After running this SQL, you can then run:
```bash
dotnet ef migrations list --startup-project ../MailEngine.Functions --context MailEngineDbContext
```

This should now show that those three migrations are applied, and only the later experimental migrations remain pending.

## Creating the Missing Table via Migrations (Recommended Approach)

To create the `failed_messages` table using migrations (instead of direct SQL), you need to follow these steps to resolve the migration history issue first:

### Step 1: Clean up the migration history
Since you have multiple conflicting initial migrations, you'll need to manually update the migration history table to reflect the actual state:

1. Connect to your PostgreSQL database directly using any PostgreSQL client (psql, pgAdmin, DBeaver, etc.)
2. Execute this SQL to mark the proper migrations as applied:
```sql
INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES
('20260202162456_InitialCreateWithNamingConventions', '8.0.0'),
('20260202190330_AddAutoGeneratedGuidsForPrimaryKeys', '8.0.0'),
('20260204225348_Tables_Again', '8.0.0')
ON CONFLICT DO NOTHING;
```

**Note:** This SQL will only insert the migration records if they don't already exist, preventing duplicate entries.

### Step 2: Apply the new migration
After updating the migration history, you can now apply the new migration that creates the missing table:

1. The migration file `20260205001550_CreateMissingFailedMessagesTable.cs` has already been created in your Migrations folder
2. Run the migration:
```bash
cd /home/omoinjm/dev/github/projects/mail-engine/njmtech-mail-engine-oauth/src/MailEngine.Infrastructure
dotnet ef database update 20260205001550_CreateMissingFailedMessagesTable --startup-project ../MailEngine.Functions --context MailEngineDbContext
```

This will create the `failed_messages` table using the proper migration mechanism.

### Alternative: Apply all remaining migrations
If you want to apply all remaining migrations (not just the failed_messages one), you can run:
```bash
cd /home/omoinjm/dev/github/projects/mail-engine/njmtech-mail-engine-oauth/src/MailEngine.Infrastructure
dotnet ef database update --startup-project ../MailEngine.Functions --context MailEngineDbContext
```

This will apply all migrations that aren't yet in the history table, which should now be just the later experimental ones.

## Verification
After applying the fix, verify that:
1. The `failed_messages` table exists in your database
2. All other expected tables exist (`oauth_tokens`, `user_mail_accounts`, `processed_messages`)
3. Running `dotnet ef migrations list` shows the appropriate migrations as applied